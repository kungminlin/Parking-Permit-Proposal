<!DOCTYPE html>
<html lang="en">
<head>
    <title>Parking Permit Proposals</title>

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" type="text/css" href="main.css">

    <!-- <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyCmSC9FYCsAMxhdtGABVsUcxPx2r7GsH-4"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript">
        const API_KEY = "AIzaSyCmSC9FYCsAMxhdtGABVsUcxPx2r7GsH-4";
        const TABLE_ID = "1JjE7hElrszOg4GWq24XTw2BK1JPe9SXVPlafJSu4";
        const DESTINATION = '201 Almond Avenue, Mountain View, CA 94022'
        const maps = require("@google/maps").createClient({
            key: API_KEY,
            Promise: Promise
        });

        var users = [];
        
        function sync() {
            var query = "SELECT * FROM " + TABLE_ID;
            var encodedQuery = encodeURIComponent(query);

            var url = ['https://www.googleapis.com/fusiontables/v2/query'];
            url.push('?sql=' + encodedQuery);
            url.push('&key=' + API_KEY);
            url.push('&callback=?');

            $.ajax({
                url: url.join(''),
                dataType: 'jsonp',
                success: function (data) {
                    var index = 0;
                    for (var i=0; i<data.columns.length; i++) {
                        if (data.columns[i].includes("street address")) index = i;
                    }
                    initializeData(data.rows);
                    getMapData(users);
                },
                failure: function (data) {
                    console.log(data);
                }
            });
        }
        
        function initializeData(data) {
            for (var i=0; i<data.length; i++) {
                users.push({email: data[i][1], first_name: data[i][2], last_name: data[i][3], address: data[i][4], legit: data[i][5], reason: data[i][6]});
            }
        }

        function getMapData(users) {
            var addresses = [];
            for (var i=0; i<users.length; i++) addresses.push(users[i].address);
            maps.distanceMatrix({
                origins: addresses,
                destinations: DESTINATION
                })
                .asPromise()
                .then((response) => {
                    initialize(response.json.rows);
                    console.log(response.json.rows);
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function initialize(distances) {
            for (var i=0; i<users.length; i++) {
                var reason;
                if (users[i].legit === "No") reason = "None";
                else reason = users[i].reason;
                $('#user-data').append("<tr><td class='name'>" + users[i].last_name + ", " + users[i].first_name + "</td><td class='email'>" + users[i].email + "</td><td class='address'>" + users[i].address + "</td><td class='distance'>" + Math.round(distances[i].elements[0].distance.value*0.000621371*100)/100 + "</td><td class='reason'>" + reason + "</td></tr>");
            }
        }

        function initMap() {
            var map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 37.3866556, lng: -122.1111336},
                zoom: 13
            });

            var layer = new google.maps.FusionTablesLayer({
                query: {
                    select: '\'What is your street address?\'',
                    from: TABLE_ID
                }
            });

            layer.setMap(map);
        }

        sync();

    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmSC9FYCsAMxhdtGABVsUcxPx2r7GsH-4&callback=initMap"></script>
</head>
<body>
    <div id="map"></div>
    <div id="container">
        <table id="user-data">
            <tr>
                <th class="name">Name</th>
                <th class="email">Email</th>
                <th class="address">Address</th>
                <th class="distance">Distance (mi)</th>
                <th class="reason">Legitimate Reason</th>
            </tr>
        </table>
    </div>
</body>
</html>